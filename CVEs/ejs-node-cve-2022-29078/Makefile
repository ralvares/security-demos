# Makefile for CVE-2022-29078 demo app container
# ===================================
# Usage:
#   make build             # Build the container image
#   make push              # Push the image to the registry
#   make run               # Run locally for testing
#   make clean             # Remove the local image
#
# Optional variables:
#   ARCH=arm64             # Default: amd64
#   REGISTRY=quay.io/vuln  # Default registry
#   TAG=latest             # Default tag

ARCH ?= amd64
REGISTRY ?= quay.io/vuln
IMAGE ?= ejs-nodejs
TAG ?= latest

.PHONY: build push run clean

build:
	@echo "Building $(IMAGE):$(TAG) for $(ARCH)..."
	podman build --arch=$(ARCH) \
		--label "app=$(IMAGE)" \
		-f Dockerfile \
		-t $(REGISTRY)/$(IMAGE):$(TAG) .

push:
	@echo "Pushing $(REGISTRY)/$(IMAGE):$(TAG)..."
	podman push $(REGISTRY)/$(IMAGE):$(TAG)

run:
	@echo "Running $(IMAGE):$(TAG) locally on port 8080..."
	podman run --rm -ti -p 8080:8080 $(REGISTRY)/$(IMAGE):$(TAG)

clean:
	@echo "Removing local image..."
	podman rmi -f $(REGISTRY)/$(IMAGE):$(TAG) || true
