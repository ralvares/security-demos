# ------------------------------------------
# 1. Builder: Compile and package as RPM
# ------------------------------------------
FROM registry.access.redhat.com/ubi8/ubi AS builder
ENV VERSION="2.4.50"

# Install build dependencies (no rpmdevtools required)
RUN dnf install -y \
      rpm-build redhat-rpm-config \
      gcc make perl wget tar which \
      pcre-devel expat-devel apr-devel apr-util-devel openssl-devel && \
    mkdir -p /root/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

# Copy spec and config
COPY httpd-custom.spec /root/rpmbuild/SPECS/httpd-custom.spec
COPY httpd.conf /root/rpmbuild/SOURCES/httpd.conf

# Download Apache + APR sources
WORKDIR /root/rpmbuild/SOURCES
RUN wget https://archive.apache.org/dist/httpd/httpd-${VERSION}.tar.gz && \
    wget https://archive.apache.org/dist/apr/apr-1.7.4.tar.gz && \
    wget https://archive.apache.org/dist/apr/apr-util-1.6.3.tar.gz

# Build RPM
WORKDIR /root
RUN rpmbuild -bb rpmbuild/SPECS/httpd-custom.spec --define '_release %{nil}'

# ------------------------------------------
# 2. Runtime: Minimal UBI 8 + custom httpd RPM
# ------------------------------------------
FROM registry.access.redhat.com/ubi8/ubi-minimal

# Copy custom-built RPM
COPY --from=builder /root/rpmbuild/RPMS/x86_64/httpd-2.4.50-1*.rpm /tmp/httpd-custom.rpm

# Install runtime deps and our package
RUN microdnf install -y mailcap perl expat openssl pcre && \
    rpm -ivh /tmp/httpd-custom.rpm && \
    microdnf clean all && \
    rm -rf /var/cache/{dnf,yum} /tmp/httpd-custom.rpm

# Prepare runtime directories
RUN mkdir -p /var/www/html /var/www/cgi-bin /var/log/httpd /run/httpd && \
    chown -R 1001:0 /var/www /var/log/httpd /run/httpd && \
    chmod -R g+rwX /var/www /var/log/httpd /run/httpd

EXPOSE 8080
USER 1001
ENTRYPOINT ["/usr/sbin/httpd", "-DFOREGROUND"]
