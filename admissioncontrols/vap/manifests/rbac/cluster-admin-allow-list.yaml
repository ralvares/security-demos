---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: cluster-admin-allow-list
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
    - apiGroups: ["rbac.authorization.k8s.io"]
      apiVersions: ["v1"]
      operations: ["CREATE", "UPDATE"]
      resources: ["clusterrolebindings"]
  validations:
  - expression: |
      object.roleRef.name != 'cluster-admin' ||
      object.subjects.all(subject,
        (subject.kind == 'User' && subject.name in [
          'kubeadmin',
          'system:admin',
          'alice@my-company.com',
          'admin'
        ]) ||
        (subject.kind == 'Group' && subject.name in [
          'system:masters',
          'ocp-sre-team',
          'system:cluster-admins'
        ]) ||
        (subject.kind == 'ServiceAccount' &&
          has(subject.namespace) &&
          (subject.namespace + '/' + subject.name) in [
            'openshift-monitoring/prometheus-k8s',
            'openshift-network-operator/cluster-network-operator',
            'openshift-cluster-storage-operator/cluster-storage-operator',
            'openshift-cluster-version/default',
            'openshift-machine-config-operator/machine-config-operator',
            'openshift-kube-storage-version-migrator/kube-storage-version-migrator-sa',
            'openshift-oauth-apiserver/oauth-apiserver-sa',
            'openshift-apiserver/openshift-apiserver-sa',
            'openshift-authentication/oauth-openshift',
            'openshift-authentication-operator/authentication-operator',
            'openshift-kube-scheduler-operator/openshift-kube-scheduler-operator',
            'openshift-etcd-operator/etcd-operator',
            'openshift-kube-apiserver-operator/kube-apiserver-operator',
            'openshift-kube-apiserver/localhost-recovery-client',
            'openshift-kube-controller-manager-operator/kube-controller-manager-operator',
            'openshift-kube-controller-manager/localhost-recovery-client',
            'openshift-kube-scheduler/localhost-recovery-client',
            'openshift-kube-storage-version-migrator-operator/kube-storage-version-migrator-operator',
            'openshift-apiserver-operator/openshift-apiserver-operator',
            'openshift-config-operator/openshift-config-operator',
            'openshift-controller-manager-operator/openshift-controller-manager-operator',
            'openshift-etcd/installer-sa',
            'openshift-kube-apiserver/installer-sa',
            'openshift-kube-controller-manager/installer-sa',
            'openshift-kube-scheduler/installer-sa',
            'openshift-service-ca-operator/service-ca-operator'
          ]
        )
      )
    message: "ClusterRoleBinding to cluster-admin contains subjects not on the allow-list. Only approved users, groups, and service accounts can be bound to cluster-admin"
    reason: Forbidden
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: cluster-admin-allow-list-binding
spec:
  policyName: cluster-admin-allow-list
  validationActions: ["Deny"]
