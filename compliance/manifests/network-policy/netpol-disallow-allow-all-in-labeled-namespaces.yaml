apiVersion: compliance.openshift.io/v1alpha1
kind: CustomRule
metadata:
  name: netpol-disallow-allow-all-in-labeled-namespaces
  namespace: openshift-compliance
spec:
  title: Disallow allow-all NetworkPolicies in labeled namespaces
  description: Detects allow-all NetworkPolicies in namespaces labeled compliance/enforce-networkpolicies=true.
  failureReason: Allow-all NetworkPolicies found in enforced namespaces.
  severity: high
  id: netpol_disallow_allow_all_labeled
  checkType: Platform
  scannerType: CEL
  inputs:
    - name: netpols
      kubernetesInputSpec:
        apiVersion: networking.k8s.io/v1
        resource: networkpolicies
    - name: namespaces
      kubernetesInputSpec:
        apiVersion: v1
        resource: namespaces
  expression: |
    !netpols.items.exists(np,
      namespaces.items.exists(ns,
        ns.metadata.name == np.metadata.namespace &&
        has(ns.metadata.labels) &&
        ns.metadata.labels.exists(k, k == 'compliance/enforce-networkpolicies') &&
        ns.metadata.labels['compliance/enforce-networkpolicies'] == 'true'
      ) &&
      np.spec.podSelector == {} &&
      (
        (has(np.spec.ingress) && size(np.spec.ingress) == 1 && np.spec.ingress[0] == {}) ||
        (has(np.spec.egress)  && size(np.spec.egress) == 1 && np.spec.egress[0]  == {})
      )
    )
