apiVersion: compliance.openshift.io/v1alpha1
kind: CustomRule
metadata:
  name: netpol-require-deny-all-in-labeled-namespaces
  namespace: openshift-compliance
spec:
  title: Require deny-all NetworkPolicy in labeled namespaces
  description: Ensures namespaces with compliance/enforce-networkpolicies=true have a deny-all NetworkPolicy.
  failureReason: One or more enforced namespaces lack a deny-all NetworkPolicy.
  severity: high
  id: netpol_require_deny_all_labeled
  checkType: Platform
  scannerType: CEL
  inputs:
    - name: netpols
      kubernetesInputSpec:
        apiVersion: networking.k8s.io/v1
        resource: networkpolicies
    - name: namespaces
      kubernetesInputSpec:
        apiVersion: v1
        resource: namespaces
  expression: |
    namespaces.items.all(ns,
      !(
        has(ns.metadata.labels) &&
        ns.metadata.labels.exists(k, k == 'compliance/enforce-networkpolicies') &&
        ns.metadata.labels['compliance/enforce-networkpolicies'] == 'true'
      ) ||
      netpols.items.exists(np,
        np.metadata.namespace == ns.metadata.name &&
        np.spec.podSelector == {} &&
        (!has(np.spec.ingress) || size(np.spec.ingress) == 0) &&
        (!has(np.spec.egress)  || size(np.spec.egress)  == 0)
      )
    )
