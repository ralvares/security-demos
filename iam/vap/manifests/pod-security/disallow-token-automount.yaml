---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: disallow-token-automount
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
    - apiGroups: [""]
      apiVersions: ["v1"]
      operations: ["CREATE", "UPDATE"]
      resources: ["pods"]
  validations:
  - expression: |
      namespaces.exists(ns,
        ns.metadata.name == object.metadata.namespace &&
        (
          // Allow if namespace has automount exemption
          (
            has(ns.metadata.labels) &&
            'custom.security/automount' in ns.metadata.labels &&
            ns.metadata.labels['custom.security/automount'] == 'true'
          ) ||
          // Or if pod explicitly disables automount
          (
            has(object.spec.automountServiceAccountToken) && 
            object.spec.automountServiceAccountToken == false
          )
        )
      )
    message: "Pod must disable automountServiceAccountToken unless namespace has custom.security/automount=true label"
    reason: Forbidden
  variables:
  - name: namespaces
    expression: |
      namespaceObject.all()
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: disallow-token-automount-binding
spec:
  policyName: disallow-token-automount
  validationActions: ["Deny"]
  matchResources:
    namespaceSelector:
      matchExpressions:
      - key: custom.security/enforce
        operator: In
        values: ["true"]
